---
title: "Peruvian women's knowledge and attitudes concerning Tuberculosis"
subtitle: "Findings from the 2018 Demographic and Health Survey"
author: "Cusi Ferradas"
date: "Jan 10, 2023"
output: prettydoc::html_pretty
editor_options: 
chunk_output_type: console
---

```{r echo=F}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r packages-and-plots, echo=FALSE}
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Packages ----
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  janitor, # data analysis utilities
  here, # force rmds to use the project folder as working directory
  haven, # for reading in stata files
  scales, # for the comma() function, among others
  ggstatsplot, # for pie charts
  patchwork, # combining plots
  tidyverse, # for everything!
  epiDisplay, #for making tables
  gmodels, #for making cross tabulations 
  janitor,
  flextable,
  esquisse,
  crosstable
)
```

The Demographic and Health Survey (DHS) are nationally-representative household surveys conducted in different countries. For the present report, the DHS women's survey conducted in Peru was analyzed to describe their knowledge and attitudes about Tuberculosis (TB). This survey was conducted in the 24 departments of the country and the "Provincia constitucional del Callao."

```{r data, echo=FALSE, include=FALSE}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Import and process data  ----
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Import the data and select the variables of interest
peru_sumdata_raw <- haven::read_dta(here("data/PEIR6IFL.DTA"),
  col_select = c(caseid, v012, v022, v013, v024, v149, v025, v474, v474a,
                 v474b, v474c, v474d, v474e, v474f, v474g, v474h, 
                 v474i, v474j, v474x, v474z, v475, s489d))

# Rename variables used in the analysis 
peru_sumdata <- peru_sumdata_raw %>%
    rename(age = v012, 
         state = v022,
         age_group = v013, 
         region = v024, 
         educ = v149, 
         urban_rural = v025,
         heard_tb = v474,
         transmission_air_cough = v474a,
         transmission_utensils = v474b,
         transmission_touch = v474c,
         transmission_food = v474d,
         transmission_sex = v474e, 
         transmission_mosquito = v474f, 
         transmission_cs1 = v474g,
         transmission_cs2 = v474h,
         transmission_cs3 = v474i,
         transmission_cs4 = v474j,
         transmission_other = v474x,
         transmission_dontknow = v474z,
         tb_cured = v475,
         tb_family_secret = s489d)

# Simplifying education categories
peru_sumdata <- peru_sumdata %>% 
  haven::as_factor() %>% 
  mutate(educ = as.character(educ),
      educ = case_when(
      educ %in% c("incomplete primary", "complete primary") ~ "Primary",
      educ %in% c("incomplete secondary", "complete secondary") ~ "Secondary",
      educ == "no education" ~ "None",
      educ == "higher" ~ "Higher",
      TRUE ~ educ),
      educ = factor(educ, 
                  levels = c("None", "Primary", "Secondary", "Higher")))

summary(peru_sumdata)
```

The survey was answered by 23,888 Peruvian women between 15 and 49 years old.

```{r introduction, echo=FALSE, include=FALSE}
# All results presented in this report are for women between 15 to 49 years old.

num_women_survey <- nrow(peru_sumdata)
num_women_survey

# Exploring the data
# General demographics of the survey population 
#Age groups
tab1(peru_sumdata$age_group, cum.percent = TRUE, graph = FALSE,
    main = "Age groups of the survey population")
#Educational level
tab1(peru_sumdata$educ, cum.percent = TRUE, graph = FALSE,
    main = "Educational levels of the survey population")
```

# Have heard about tuberculosis 

Of all Peruvian women included in the survey, 93.3% have heard about tuberculosis (Table 1 and Figure 1).

```{r heard about tuberculosis (general), echo=FALSE}
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## Heard about tuberculosis ----
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#Number of women who have heard of TB
table1 <- peru_sumdata %>% tabyl(heard_tb) %>% 
  adorn_pct_formatting() %>% 
  adorn_totals() %>%
  flextable::flextable()
table1 <- set_header_labels(table1, heard_tb = "Heard about TB", n = "Number",
                            percent = "Percent")
table1

data_heardtb <- peru_sumdata %>% count(heard_tb) 
data_heardtb <- data_heardtb %>% mutate(heard_tb_percent = n/sum(n)*100)

ggplot(data_heardtb) +
  aes(x = heard_tb, y = n, fill = heard_tb) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label=n), vjust=1.5) +
  scale_fill_manual(values=c("burlywood3", "antiquewhite3")) +
  labs(x = "Heard about tuberculosis", y = "Number of women",
  title = "Figure 1. Number of Peruvian women who have heard about tuberculosis") +
  theme_minimal()
```

## Have heard about TB according to their educational level in six different departments of Peru.

For this analysis, six departments of the country are shown, two from the coast (Lima and Arequipa), two from the highlands (Ancash and Apurimac), and two from the rain forest (Amazonas and Loreto). 

The percentage of people who have heard about tuberculosis increases as the level of education increases (Figure 2). This increase is more noticeable between the group who has received no education and those who have finished primary education, especially in Arequipa where only 36% of women with no education have heard about TB, while 82% of women with primary education had. 

```{r heard about tuberculosis according to their education level and region, echo=FALSE}

peru_sumdata %>% 
  mutate(region = factor(region, levels=c("lima", "arequipa", "ancash", "apurimac", "amazonas",
                                          "loreto"))) %>%
  dplyr::select(age, educ, heard_tb, region) %>% 
  filter (region %in% c("amazonas", "loreto", "ancash", "apurimac", "lima", "arequipa")) %>%
  group_by(region, educ) %>%
  count(heard_tb) %>%
  mutate(pct = n*100/sum(n), 
         pct=round(pct, 0)) %>%
  filter (heard_tb == "yes") %>%
  ggplot() +
  aes(x = educ, y = pct, fill = educ) +
  geom_col() +
  geom_text(aes(label = pct), vjust = 1.5, size = 3) +
  scale_fill_manual(values=c("antiquewhite", "bisque1", "burlywood3", "darkgoldenrod")) +
  labs(x = "Education level ",
    y = "Percentage",
    title = "Figure 2. Heard about TB according to education level ") +
  theme_minimal() +
  facet_wrap(~region, scales = "free", ncol = 2)
```

## Median age of people who have heard and have not heard about TB in six different regions of Peru.

The median age of women indicating that they have heard about TB is higher than the median age of women in the same age group indicating that they have not heard about TB in all regions besides Apurimac (Figure 2). 

```{r heard about tuberculosis according to median age, echo=FALSE}
peru_sumdata_age_tb_region <- 
  peru_sumdata %>% 
  mutate(region = factor(region, levels=c("lima", "arequipa", "ancash", "apurimac", "amazonas",
                                          "loreto"))) %>%
  dplyr::select(age, heard_tb, region) %>% 
  filter (region %in% c("amazonas", "loreto", "ancash", "apurimac", "lima", "arequipa")) %>%
  group_by(region, heard_tb) %>%
  summarize(median_age = median(age))

reactable::reactable(peru_sumdata_age_tb_region)

peru_sumdata_age_tb_region1 <- 
  peru_sumdata %>% 
  mutate(region = factor(region, levels=c("lima", "arequipa", "ancash", "apurimac", "amazonas",
                                          "loreto"))) %>%
  dplyr::select(age, heard_tb, region) %>% 
  filter (region %in% c("amazonas", "loreto", "ancash", "apurimac", "lima", "arequipa"))

ggplot(peru_sumdata_age_tb_region1) +
  aes(x = age, y = heard_tb, fill = heard_tb) +
  geom_boxplot() +
  scale_fill_hue(direction = 1) +
  labs(
    x = "Age",
    y = "Heard about TB",
    title = "Box plots of age according to knowledge about TB",
    fill = "Heard about TB"
  ) +
  theme_minimal() +
  facet_wrap(~region, scales = "free", ncol = 2)
```

# TB will be kept as a secret

Women included in the survey answered the question "If a family member gets TB, would you keep it as a secret." More than 40% of women living in urban and rural areas said that they would keep their family member's diagnosis of TB as a secret. This may be because of negative social attitudes, like stigmatization against people with this disease in some communities, as has been reported previously in other countries (Dodor, 2012; Armijos et al.,2008). 

```{r knowledge that TB can be cured between urban and rural settlements, echo=FALSE}
#Filtering the data to only include the variables urban_rural and tb_family_secret
peru_urbanrural_secret <- 
  peru_sumdata %>%
  dplyr::select(urban_rural, tb_family_secret) %>%
  filter(!is.na(tb_family_secret)) 

#Relabel categories of tb_family_secret
peru_urbanrural_secret$tb_family_secret <- factor(peru_urbanrural_secret$tb_family_secret,
                       levels = c("no", "si guardarÃ­a el secreto", "no sabe/no esta segura/depende"),
                       labels = c("No", "Yes", "Don't know/Not sure/It depends")) 

#Making a contingency table for urban_rural and tb_family_secret
#Rename tb_family_secret for label
peru_urbanrural_secret_1 <-
  peru_urbanrural_secret %>% 
  rename("Would keep TB dx as secret" = tb_family_secret)
#Making the table
ct1 <- crosstable(peru_urbanrural_secret_1, c("Would keep TB dx as secret"),
                  by=urban_rural, total="both", 
                  percent_pattern="{n} ({p_row}/{p_col})",
                  percent_digits=0) %>%
       as_flextable() 
ct1

ggplot(peru_urbanrural_secret) +
  aes(x = urban_rural, fill = tb_family_secret) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values=c("chocolate", "burlywood3", "darkgoldenrod")) +
  labs(
    x = "Place of residency",
    y = "Count",
    title = "Bar graph showing how many women will keep TB diagnosis as a secret",
    fill = "Keep TB diagnosis as a secret"
  ) +
  theme_minimal()
```
